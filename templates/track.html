{% extends "base.html" %}
{% block content %}
<section class="card">
  <h1>{{ shipment['title'] }} — <small class="muted">Tracking: {{ shipment['tracking'] }}</small></h1>

  <div id="map" style="height:420px; margin-bottom:1rem;"></div>

  <div class="grid-2">
    <div>
      <h3>Status & Checkpoints</h3>
      <ol id="timeline" class="timeline"></ol>
    </div>

    <div>
      <h3>Email updates</h3>
      <form id="sub-form" class="stack">
        <label for="email">Email address</label>
        <input id="email" type="email" placeholder="you@example.com" required>
        <button type="submit">Subscribe</button>
        <small class="muted">You’ll get an email whenever a new checkpoint is added.</small>
      </form>

      <hr>
      <h4>Debug / Links</h4>
      <p class="muted">Tracking number: <code>{{ shipment['tracking'] }}</code></p>
    </div>
  </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // pass server data into JS
  const SHIPMENT = {{ shipment | tojson }};
  const CHECKPOINTS = {{ checkpoints | tojson }};

  let map, markers = [], path;
  function initMap(){
    map = L.map('map', { scrollWheelZoom: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    const points = [
      [SHIPMENT.origin_lat, SHIPMENT.origin_lng],
      ...CHECKPOINTS.map(c => [c.lat, c.lng]),
      [SHIPMENT.dest_lat, SHIPMENT.dest_lng]
    ];
    path = L.polyline(points).addTo(map);
    const bounds = L.latLngBounds(points).pad(0.2);
    map.fitBounds(bounds);

    L.marker(points[0]).addTo(map).bindPopup('Origin');
    CHECKPOINTS.forEach(c => L.marker([c.lat, c.lng]).addTo(map).bindPopup(c.label));
    L.marker(points[points.length-1]).addTo(map).bindPopup('Destination');
  }

  function renderTimeline(){
    const list = document.getElementById('timeline');
    list.innerHTML = '';
    CHECKPOINTS.forEach(c => {
      const li = document.createElement('li');
      const t = new Date(c.timestamp);
      li.innerHTML = `<strong>${c.label}</strong> — ${t.toLocaleString()}<br><span class="muted">${c.note || ''} (${c.lat.toFixed(3)}, ${c.lng.toFixed(3)})</span>`;
      list.appendChild(li);
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    initMap();
    renderTimeline();

    document.getElementById('sub-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const res = await fetch(`/api/shipments/${encodeURIComponent(SHIPMENT.tracking)}/subscribe`, {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email })
      });
      if (res.ok) { alert('Subscribed!'); document.getElementById('email').value=''; }
      else { const t = await res.text(); alert('Error: ' + t); }
    });
  });
</script>
{% endblock %}
