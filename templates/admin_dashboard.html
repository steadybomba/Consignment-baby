{% extends "base.html" %}
{% block content %}
<section class="card">
  <h1>Admin Dashboard (Server)</h1>
  <p class="muted">This server-rendered dashboard is a fallback. For the full SPA, open <a href="{{ url_for('admin_app') }}">Admin SPA</a>.</p>

  <div id="shipments-container">Loading shipments…</div>
</section>

<script>
  async function loadShipments(){
    const el = document.getElementById('shipments-container');
    el.innerHTML = 'Loading…';
    const res = await fetch('/api/admin/shipments');
    if (!res.ok){ el.innerHTML = 'Failed to load shipments'; return; }
    const data = await res.json();
    if (!data.length){ el.innerHTML = '<p>No shipments found.</p>'; return; }
    const list = document.createElement('div');
    list.style.display = 'grid';
    list.style.gap = '1rem';
    data.forEach(s => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3>${s.title} — <small class="muted">${s.tracking_number}</small></h3>
        <p>Status: ${s.status} — Updated: ${s.updated_at}</p>
        <button data-track="${s.tracking_number}" class="open-map">Open map</button>
        <button data-track="${s.tracking_number}" class="simulate">Simulate</button>
        <div class="muted">Subscribers: ${s.subscribers.length}</div>
      `;
      // actions
      card.querySelector('.open-map').onclick = ()=> window.open(`/track/${s.tracking_number}`, '_blank');
      card.querySelector('.simulate').onclick = async ()=> {
        await fetch(`/api/admin/shipments/${encodeURIComponent(s.tracking_number)}/simulate`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ steps:6, interval:2 })});
        alert('Simulation started');
      };
      list.appendChild(card);
    });
    el.innerHTML = '';
    el.appendChild(list);
  }

  document.addEventListener('DOMContentLoaded', loadShipments);
</script>
{% endblock %}
